<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plan de l'ENSAE</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100vh; background: #f3f3f3; }

    /* Bouton retour en haut-droite */
    #back-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      padding: 10px 15px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    #back-btn:hover {
      background: #f0f0f0;
    }

    /* Style des labels de salle (numéro au centroïde) */
    .room-label {
      color: #b0b0b0;          /* gris clair */
      font-size: 11px;
      font-weight: 600;
      text-shadow: 0 0 2px #ffffff;
      white-space: nowrap;

       /* Centrages horizontal & vertical autour du point */
      position: relative;
      left: 0;
      top: 0;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    /* Salles libres : labels en violet plus marqué */
    .room-label-free {
      color: #7c3aed;   /* violet */
      font-size: 11px;
      font-weight: 700;
      text-shadow: 0 0 2px #ffffff;
      white-space: nowrap;
      position: relative;
      left: 0;
      top: 0;
      transform: translate(-50%, -50%);
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- Bouton Retour qui conserve les salles disponibles -->
  <button id="back-btn" type="button" onclick="window.history.back();">
    ⟵ Retour
  </button>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <script>
    // Init carte en coordonnées simples (plan 2D sans projection)
    const map = L.map("map", {
      crs: L.CRS.Simple,
      minZoom: -4,
    });
    
    // Liste des salles libres (Python -> JS). On doit s'assurer d'avoir concordance exacte des labels.
    const rawSallesLibres = {{ (salles_libres | default([])) | tojson | safe }};
    
    // On retire les espaces et on met en majuscules pour éviter les erreurs de correspondance
    const sallesLibres = (rawSallesLibres || []).map(s =>
      String(s).trim().toUpperCase().replace(/\s+/g, "")
    );

     // Pour débug -> à retirer une fois que le surbrillage fonctionne bien
    console.log("rawSallesLibres =", rawSallesLibres);
    console.log("sallesLibres normalisées =", sallesLibres);

    // URL du GeoJSON côté Flask
    const geojsonUrl = "{{ proxy_prefix }}/static/data/plan_virtuel_rutabaga.geojson";

    fetch(geojsonUrl)
      .then(response => {
        if (!response.ok) throw new Error("Erreur HTTP " + response.status);
        return response.json();
      })
      .then(data => {
        const layer = L.geoJSON(data, {
          // Style : violet très clair + contour noir, ou foncé si occupée
          style: function (feature) {
            const p = feature.properties || {};
            const rawLabel = p.label || "";
            const normLabel = String(rawLabel).trim().toUpperCase().replace(/\s+/g, "");
            const isFree = sallesLibres.includes(normLabel);

            return {
              color: "#000000",                            // contour noir
              weight: 1,
              fillColor: isFree ? "#C084FC" : "#E8D9FF",   // violet plus foncé si libre
              fillOpacity: isFree ? 0.9 : 0.7
            };
          },
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const rawLabel = p.label || "";
            const normLabel = String(rawLabel).trim().toUpperCase().replace(/\s+/g, "");
            const isFree = sallesLibres.includes(normLabel);

            // Popup
            layer.bindPopup(
              `<b>${rawLabel}</b>` +
              (isFree ? "<br><span style='color:#7c3aed;'>Salle disponible</span>" : "")
            );

            // Label du numéro de salle au centroïde
            // On utilise le centroïde approximé via le centre de l'emprise
            const bounds = layer.getBounds();
            const center = bounds.getCenter();

            L.marker(center, {
              icon: L.divIcon({
                className: "",
                html: `<div class="${isFree ? "room-label-free" : "room-label"}">${rawLabel}</div>`,
                iconSize: null,
                iconAnchor: [0, 0]
              }),
              interactive: false
            }).addTo(map);
          }
        }).addTo(map);

        map.fitBounds(layer.getBounds());
      })
      .catch(err => {
        console.error("Erreur lors du chargement du GeoJSON :", err);
        alert("Impossible de charger le plan (GeoJSON).");
      });
  </script>
</body>
</html>